<?phpinclude_once("dbconfig.php");include_once("functions.php");function addCalendar($st, $et, $sub, $ade){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "insert into `jqcalendar` (`subject`, `starttime`, `endtime`, `isalldayevent`) values ('"      .mysql_real_escape_string($sub)."', '"      .php2MySqlTime(js2PhpTime($st))."', '"      .php2MySqlTime(js2PhpTime($et))."', '"      .mysql_real_escape_string($ade)."' )";    //echo($sql);		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] = mysql_insert_id();    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function addDetailedCalendar($st,$hora_inicio,$et,$servicios,$usuarios,$disposicion,$observaciones,$pendientes,$liberacion){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "insert into tbltareas (fecha_inicio,hora_inicio,hora_fin,idso,propietario,disposicion,observaciones,pendientes,idEstado) values ('"      .php2MySqlTime(js2PhpTime($st))."', '"      .mysql_real_escape_string($hora_inicio)."', '"      .mysql_real_escape_string($et)."', '"      .mysql_real_escape_string($servicios)."', '"      .mysql_real_escape_string($usuarios)."', '"      .mysql_real_escape_string($disposicion)."', '"      .mysql_real_escape_string($observaciones)."', '"      .mysql_real_escape_string($pendientes)."', '"      .mysql_real_escape_string($liberacion)."' )";    //echo($sql);		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $sql3="select max(idtareas) as idtareas from tbltareas";      $resultado = mysql_query($sql3);    while ($row = mysql_fetch_object($resultado)) {      $ret['idtarea']=$row->idtareas;      }      $ret['Msg'] = 'add success';      $ret['Data'] = mysql_insert_id();    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function listCalendarByRange($sd, $ed){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  try{    $db = new DBConnection();    $db->getConnection();  $usuarios=$_REQUEST["usuarios"];    $array_tecnicos = array($usuarios);      //$variable="'".implode("','",$a1)."'";    $usuarios2="'".implode("''",$array_tecnicos)."'";$gris[1]="0";    $sql = "SELECT ta.idEstado AS tarea_idestado, ta.idcategoria AS tarea_idcategoria, ta.idtareas AS tarea_idtareas, ta.propietario AS tarea_propietario, ta.fecha_inicio AS tarea_fecha_inicio, ta.hora_inicio AS tarea_hora_inicio, ta.hora_fin AS tarea_hora_fin, ta.pendientes AS tarea_pendientes, us.name AS us_name,so.asunto AS so_asunto,cli.nombre_empresa as cliente_empresa,so.idestado as so_idestado,((TIMESTAMPDIFF( SECOND , TIMESTAMP( so.fecha_inicio_programado, so.hora_inicio_programado ) , NOW())/3600) / ( TIMESTAMPDIFF( SECOND , TIMESTAMP( so.fecha_inicio_programado, so.hora_inicio_programado ) , TIMESTAMP( so.fecha_fin_programado, so.hora_fin_programado )) /3600 )) *100 as buffer        FROM tbltareas ta        INNER JOIN sec_users us ON ta.propietario = us.login        INNER JOIN tblsolicitudes so ON so.id = ta.idso inner join tblclientes cli On cli.id_cli=so.Idcliente where ta.propietario in ($usuarios2) and ta.fecha_inicio between '"    .php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."'order by ta.hora_inicio asc";    $handle = mysql_query($sql);    //echo $sql;    while ($row = mysql_fetch_object($handle)) {      $libera=$row->tarea_idestado;      $buffer=$row->buffer;      $catego=$row->tarea_idcategoria;      if($row->so_idestado==1)      {        if($libera==2){$colore=6;}         elseif($libera==1){if($buffer>=0 && $buffer <=33.9) {$colore=9;}elseif($buffer>=34 && $buffer<=66.9){$colore=12;}elseif($buffer>=67 && $buffer<=100.9){$colore=1;}elseif($buffer>=101){$colore=$gris[1];} elseif($buffer<0){$colore=3;}}      }      else      {        $colore=21;      }      //$ret['events'][] = $row;      //$attends = $row->AttendeeNames;      //if($row->OtherAttendee){      //  $attends .= $row->OtherAttendee;      //}      //echo $row->re;      $ret['events'][] = array(        $row->tarea_idtareas,        $row->us_name."--".$row->cliente_empresa."--".$row->so_asunto,        php2JsTime(mySql2PhpTime($row->tarea_fecha_inicio." ".$row->tarea_hora_inicio)),        php2JsTime(mySql2PhpTime($row->tarea_fecha_inicio. " ".$row->tarea_hora_fin)),        0,//$row->IsAllDayEvent        0, //more than one day event        //$row->InstanceType,        0,//Recurring event,        $colore,        1,//editable        $row->tarea_pendientes,         ''//$attends      );    }	}catch(Exception $e){     $ret['error'] = $e->getMessage();  }  return $ret;}function listCalendar($day, $type){  $phpTime = js2PhpTime($day);  //echo $phpTime . "+" . $type;  switch($type){    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      break;    case "week":      //suppose first day of a week is monday       $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));      break;  }  //echo $st . "--" . $et;  return listCalendarByRange($st, $et);}function updateCalendar($id, $st, $et){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "update `tbltareas` set"      . " `fecha_inicio`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `hora_inicio`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `hora_fin`='" . php2MySqlTime(js2PhpTime($et)) . "' "      . "where `idtareas`=" . $id;    //echo $sql;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';      $ret['idtarea'] = $id;    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function updateDetailedCalendar($id, $st,$hora_inicio,$et,$servicios,$colorvalue,$usuarios,$disposicion,$observaciones,$pendientes,$liberacion){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "update `tbltareas` set"      . " `fecha_inicio`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `hora_inicio`='" .mysql_real_escape_string($hora_inicio). "', "      . " `hora_fin`='" .mysql_real_escape_string($et). "', "      . " `idso`='" . mysql_real_escape_string($servicios) . "', "      . " `Color`='" . mysql_real_escape_string($colorvalue) . "', "      . " `propietario`='" . mysql_real_escape_string($usuarios) . "', "      . " `disposicion`='" . mysql_real_escape_string($disposicion) . "', "      . " `observaciones`='" . mysql_real_escape_string($observaciones) . "', "      . " `idEstado`='" . mysql_real_escape_string($liberacion) . "', "      . " `pendientes`='" . mysql_real_escape_string($pendientes) . "' "      . "where `idtareas`=" . $id;    //echo $sql;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';      $ret['idtarea'] = $id;    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function removeCalendar($id){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "delete from `jqcalendar` where `id`=" . $id;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $_GET["method"];switch ($method) {    case "add":        $ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["IsAllDayEvent"]);        break;    case "list":        $ret = listCalendar($_POST["showdate"], $_POST["viewtype"]);        break;    case "update":        $ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"]);        break;     case "remove":        $ret = removeCalendar( $_POST["calendarId"]);        break;    case "adddetails":        $st = $_POST["stpartdate"];        $hora_inicio= $_POST["stparttime"];        $et = $_POST["etparttime"];        if(isset($_GET["id"])){            $ret = updateDetailedCalendar($_GET["id"], $st, $hora_inicio, $et,                $_POST["servicios"],                  $_POST["colorvalue"],$_POST["usuarios"],$_POST["disposicion"],$_POST["observaciones"],$_POST["pendientes"],$_POST["liberacion"]);        }else{            $ret = addDetailedCalendar($st, $hora_inicio, $et,                $_POST["servicios"],                  $_POST["usuarios"],$_POST["disposicion"],$_POST["observaciones"],$_POST["pendientes"],$_POST["liberacion"]);        }                break; }echo json_encode($ret); ?>